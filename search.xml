<?xml version="1.0" encoding="utf-8"?>
<search>
  
    
    <entry>
      <title><![CDATA[ansible-setup-module-problem.md]]></title>
      <url>%2F2017%2F01%2F07%2Fansible-setup-module-problem-md%2F</url>
      <content type="text"><![CDATA[ansible的setup模块可能导致进程卡死问题背景 概述 一次 playbook 的测试过程中，发现一个奇怪的现象：就是执行 playbook 的过程中，总会出现一个 setup 的步骤，并且这个步骤执行的时间非常的长，达到5分钟，甚至有的环境会直接卡死，进程无法中断。详细的问题描述见github-ansible 环境介绍 通过ansible节点管理openstack环境,所以环境中有很多虚拟网卡，导致setup模块的问题。 问题现象 test.yaml 文件 12345---- hosts: xx.xx.xx.xx tasks: - name: test shell: echo aaaa 执行之后，直接卡死，就像下面这样，一直没有返回。 12345# ansible-playbook test.yamlPLAY [xx.xx.xx.xx] ************************************************************TASK [setup] ******************************************************************* 问题分析分别到ansible节点和目标节点查看原因。 ansible节点 1237901 pts/2 Sl+ 2:43 \_ /usr/bin/python /usr/bin/ansible all -m setup7912 pts/2 S+ 0:00 \_ /usr/bin/python /usr/bin/ansible all -m setup7960 pts/2 S+ 0:00 \_ ssh -C -o ControlMaster=auto -o ControlPersist=60s -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 -o ControlPath=/root/.ansible/cp/ansible-ssh-%h-%p-%r -tt xx.xx.xx.xx /bin/sh -c '/usr/bin/python /root/.ansible/tmp/ansible-tmp-1483608708.39-143999004080315/setup.py; rm -rf "/root/.ansible/tmp/ansible-tmp-1483608708.39-143999004080315/" &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0' 目标节点 12349036 pts/1 Ss+ 0:00 /bin/sh -c /usr/bin/python /root/.ansible/tmp/ansible-tmp-1483608708.39-143999004080315/setup.py; rm -rf "/root/.ansible/tmp/ansible-tmp-1483608708.39-143999004080315/" &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0 49083 pts/1 S+ 0:00 \_ /usr/bin/python /root/.ansible/tmp/ansible-tmp-1483608708.39-143999004080315/setup.py 49213 pts/1 D+ 0:00 \_ /usr/bin/python /tmp/ansible_bx9h6K/ansible_module_setup.py 请注意，这里进程进入了 D 状态，这个状态的意思是不可中断的进程，会一直卡着，无法返回。 setup模块 既然问题出在 setup 模块，那就先来看下setup 模块是干什么的，通过查看源码和文档，这个是获取系统信息，并将相关变量存储到facts中，具体的就不在这里展开分析了。 其中获取网卡信息，过程大概如下123456789101180013 pts/2 Ss+ 0:00 /bin/sh -c /usr/bin/python /root/.ansible/tmp/ansible-tmp-1483615192.93-195988658363074/setup.py; rm -rf "/root/.ansible/tmp/ansible-tmp-1483615192.93-195988658363074/" &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0 80034 pts/2 S+ 0:00 \_ /usr/bin/python /root/.ansible/tmp/ansible-tmp-1483615192.93-195988658363074/setup.py 80073 pts/2 S+ 0:00 \_ /usr/bin/python /tmp/ansible_pBITNP/ansible_module_setup.py 80092 pts/2 Sl+ 0:25 \_ /usr/bin/ruby /usr/bin/facter --puppet --json 15676 pts/2 R+ 0:00 \_ /sbin/ip link show ovs-system 80013 pts/2 Ss+ 0:00 /bin/sh -c /usr/bin/python /root/.ansible/tmp/ansible-tmp-1483615192.93-195988658363074/setup.py; rm -rf "/root/.ansible/tmp/ansible-tmp-1483615192.93-195988658363074/" &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sleep 0 80034 pts/2 S+ 0:00 \_ /usr/bin/python /root/.ansible/tmp/ansible-tmp-1483615192.93-195988658363074/setup.py 80073 pts/2 S+ 0:00 \_ /usr/bin/python /tmp/ansible_pBITNP/ansible_module_setup.py 80092 pts/2 Sl+ 0:25 \_ /usr/bin/ruby /usr/bin/facter --puppet --json 12971 pts/2 R+ 0:00 \_ /sbin/ip link show ifb992 问题处理openstack的网络节点，会有非常多的虚拟网卡，我的这个环境中虚拟网卡个数接近1000个了，导致收集信息的时间长。既然只是获取信息，那就能否跳过这一个步骤呢？当然是有的，修改配置文件 /etc/ansible/ansible.cfg，其中有一个配置项 gather_subset 1234#原值：#gather_subset=all#新值：gather_subset=!all 修改之后，再次执行playbook，问题得到解决。具体其他的配置项，可以查看setup的源码。]]></content>
    </entry>

    
    <entry>
      <title><![CDATA[2016年终讲]]></title>
      <url>%2F2016%2F12%2F23%2F2016%E5%B9%B4%E7%BB%88%E8%AE%B2%2F</url>
      <content type="text"><![CDATA[2016年终讲时间过的很快，不经意间又过了一年。雁过留痕，总要留下点什么。 期望结果 有房子，有车子，说走就走的旅行； 云计算，做平台，踏踏实实的创业； 实际现象 科技园，忙创业，路漫长； 代码汪，黑锅侠，躺中枪； 遭收购，汪侠包，销售慌； 人心去，无鼎力，途茫茫；]]></content>
    </entry>

    
    <entry>
      <title><![CDATA[helloblog]]></title>
      <url>%2F2016%2F12%2F07%2Fhelloblog%2F</url>
      <content type="text"><![CDATA[博客终于开张了！一直想整一个自己的技术博客，最近终于抽出时间整起来了，感谢gitbub,hexo等相关技术贡献者，给大家带来的免费福利，搭建博客的过程很简单。 为什么要搭建自己的博客？ 为了更好的记录和分享 结交更多志同道合的朋友 表达自己最真实的想法 坚持写作，表达，能更好的理解相关内容 虽然以前也有在 CSDN博客 上写过几篇，但是没有坚持下来（当然也有其他的一些原因），这次打算坚持写下去。以前文笔不好，也许写者写着就好起来了呢；以前不喜欢记录和分享，主要还是太懒了，好记性不如烂笔头，自己写出来的东西才是自己理解的，没有明白这个道理，始终只能在入门阶段徘徊，想要成为一代宗师，自己的总结和思考必不可少。 这并不仅仅只是一个技术博客，也许偶尔也会发发牢骚。 好了，写的有点乱，后面坚持写自己的博客！ 最后，以前的 CSDN博客 不再更新，相关文章也会在近期转移到本博客。]]></content>
    </entry>

    
  
  
</search>
